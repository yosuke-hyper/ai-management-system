/*
  # Êó¢Â≠ò„Éá„Éº„Çø„ÅÆ„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÁßªË°å

  ## Ê¶ÇË¶Å
  Êó¢Â≠ò„ÅÆ2„É¶„Éº„Ç∂„Éº„ÄÅ3Â∫óËàó„ÄÅ12Êó•Â†±„Å™„Å©„ÅÆ„Éá„Éº„Çø„ÇíÊñ∞„Åó„ÅÑ„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÊßãÈÄ†„Å´ÁßªË°å„Åó„Åæ„Åô„ÄÇ

  ## ÂÆüË°åÂÜÖÂÆπ
    1. „Éá„Éï„Ç©„É´„ÉàÁµÑÁπî„ÄåÊó¢Â≠ò„Éá„Éº„ÇøÁµÑÁπî„Äç„Çí‰ΩúÊàê
    2. ÂÖ®„ÉÜ„Éº„Éñ„É´„ÅÆ organization_id „ÇíË®≠ÂÆö
    3. Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Çí organization_members „Å´ÁôªÈå≤
       - admin -> owner
       - staff -> member
    4. „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÇíÁ¢∫Ë™ç

  ## ÂÆâÂÖ®ÊÄß
    - „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑÔºàSupabase Edge FunctionÂà∂Á¥ÑÔºâ
    - ÂêÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅßÁ¢∫Ë™ç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂá∫Âäõ
    - „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇÊó¢Â≠ò„Éá„Éº„Çø„ÅØ‰øùË≠∑„Åï„Çå„Çã
*/

-- ============================================
-- 1. „Éá„Éï„Ç©„É´„ÉàÁµÑÁπî„ÅÆ‰ΩúÊàê
-- ============================================

DO $$
DECLARE
  org_id uuid;
BEGIN
  -- Êó¢Â≠ò„ÅÆÁµÑÁπî„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization' LIMIT 1;
  
  IF org_id IS NULL THEN
    -- Êñ∞Ë¶è‰ΩúÊàê
    INSERT INTO organizations (
      name,
      slug,
      email,
      subscription_status,
      subscription_plan,
      trial_ends_at,
      max_stores,
      max_users,
      max_ai_requests_per_month
    )
    VALUES (
      'Êó¢Â≠ò„Éá„Éº„ÇøÁµÑÁπî',
      'default-organization',
      'coccroco.2014@gmail.com',
      'active',
      'enterprise',
      NULL,
      999,
      999,
      9999
    )
    RETURNING id INTO org_id;
    
    RAISE NOTICE '‚úÖ „Éá„Éï„Ç©„É´„ÉàÁµÑÁπî„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü (ID: %)', org_id;
  ELSE
    RAISE NOTICE '‚è≠Ô∏è  „Éá„Éï„Ç©„É´„ÉàÁµÑÁπî„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô (ID: %)', org_id;
  END IF;
END $$;

-- ============================================
-- 2. profiles „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE profiles
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ profiles: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 3. stores „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE stores
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ stores: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 4. vendors „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE vendors
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ vendors: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 5. daily_reports „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE daily_reports
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ daily_reports: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 6. targets „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE targets
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ targets: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 7. store_assignments „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE store_assignments
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ store_assignments: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 8. store_vendor_assignments „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE store_vendor_assignments
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ store_vendor_assignments: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 9. daily_targets „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE daily_targets
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ daily_targets: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 10. expense_baselines „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE expense_baselines
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ expense_baselines: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 11. daily_report_vendor_purchases „ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE daily_report_vendor_purchases
  SET organization_id = org_id
  WHERE organization_id IS NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ daily_report_vendor_purchases: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 12. AIÈñ¢ÈÄ£„ÉÜ„Éº„Éñ„É´„ÅÆÁßªË°å
-- ============================================

DO $$
DECLARE
  org_id uuid;
  updated_count int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  UPDATE ai_conversations SET organization_id = org_id WHERE organization_id IS NULL;
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ ai_conversations: % ‰ª∂Êõ¥Êñ∞', updated_count;
  
  UPDATE ai_messages SET organization_id = org_id WHERE organization_id IS NULL;
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ ai_messages: % ‰ª∂Êõ¥Êñ∞', updated_count;
  
  UPDATE ai_generated_reports SET organization_id = org_id WHERE organization_id IS NULL;
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ ai_generated_reports: % ‰ª∂Êõ¥Êñ∞', updated_count;
  
  UPDATE report_schedules SET organization_id = org_id WHERE organization_id IS NULL;
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ report_schedules: % ‰ª∂Êõ¥Êñ∞', updated_count;
  
  UPDATE ai_usage_tracking SET organization_id = org_id WHERE organization_id IS NULL;
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  RAISE NOTICE '‚úÖ ai_usage_tracking: % ‰ª∂Êõ¥Êñ∞', updated_count;
END $$;

-- ============================================
-- 13. Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Çí organization_members „Å´ÁôªÈå≤
-- ============================================

DO $$
DECLARE
  org_id uuid;
  inserted_count int := 0;
  user_record RECORD;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  -- ÂêÑ„É¶„Éº„Ç∂„Éº„ÇíÁôªÈå≤
  FOR user_record IN 
    SELECT p.id, p.role 
    FROM profiles p
    WHERE NOT EXISTS (
      SELECT 1 FROM organization_members om
      WHERE om.user_id = p.id AND om.organization_id = org_id
    )
  LOOP
    INSERT INTO organization_members (organization_id, user_id, role)
    VALUES (
      org_id,
      user_record.id,
      CASE
        WHEN user_record.role = 'admin' THEN 'owner'
        WHEN user_record.role = 'manager' THEN 'admin'
        ELSE 'member'
      END
    )
    ON CONFLICT (organization_id, user_id) DO NOTHING;
    
    inserted_count := inserted_count + 1;
  END LOOP;
  
  RAISE NOTICE '‚úÖ organization_members: % ‰ª∂ËøΩÂä†', inserted_count;
END $$;

-- ============================================
-- 14. „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÅÆÁ¢∫Ë™ç
-- ============================================

DO $$
DECLARE
  org_id uuid;
  profiles_null int;
  stores_null int;
  reports_null int;
  org_members int;
BEGIN
  SELECT id INTO org_id FROM organizations WHERE slug = 'default-organization';
  
  -- organization_id „Åå NULL „ÅÆ„É¨„Ç≥„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  SELECT COUNT(*) INTO profiles_null FROM profiles WHERE organization_id IS NULL;
  SELECT COUNT(*) INTO stores_null FROM stores WHERE organization_id IS NULL;
  SELECT COUNT(*) INTO reports_null FROM daily_reports WHERE organization_id IS NULL;
  SELECT COUNT(*) INTO org_members FROM organization_members WHERE organization_id = org_id;
  
  RAISE NOTICE '========================================';
  RAISE NOTICE 'üìä „Éá„Éº„ÇøÁßªË°åÂÆå‰∫Ü„É¨„Éù„Éº„Éà';
  RAISE NOTICE '========================================';
  RAISE NOTICE 'ÁµÑÁπîID: %', org_id;
  RAISE NOTICE 'ÁµÑÁπîÂêç: Êó¢Â≠ò„Éá„Éº„ÇøÁµÑÁπî';
  RAISE NOTICE 'ÁµÑÁπî„É°„É≥„Éê„ÉºÊï∞: %', org_members;
  RAISE NOTICE '----------------------------------------';
  RAISE NOTICE 'NULL „ÉÅ„Çß„ÉÉ„ÇØ:';
  RAISE NOTICE '  profiles (NULL): %', profiles_null;
  RAISE NOTICE '  stores (NULL): %', stores_null;
  RAISE NOTICE '  daily_reports (NULL): %', reports_null;
  RAISE NOTICE '========================================';
  
  IF profiles_null = 0 AND stores_null = 0 AND reports_null = 0 THEN
    RAISE NOTICE '‚úÖ „Éá„Éº„ÇøÁßªË°åÊàêÂäüÔºÅÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÁµÑÁπî„Å´Á¥ê‰ªò„Åç„Åæ„Åó„Åü';
  ELSE
    RAISE WARNING '‚ö†Ô∏è  ‰∏ÄÈÉ®„ÅÆ„Éá„Éº„Çø„ÅåÊú™ÁßªË°å„Åß„Åô„ÄÇÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ';
  END IF;
END $$;
